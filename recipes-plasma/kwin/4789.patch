From 1af9ed4ecd71ef682c713291dc8b482618a64df8 Mon Sep 17 00:00:00 2001
From: Aleix Pol <aleixpol@kde.org>
Date: Wed, 13 Dec 2023 23:15:50 +0100
Subject: [PATCH] glshadermanager: Fix nv12 shader for older versions of
 opengles

It wasn't compiling for PowerVR drivers.
---
 src/opengl/glshadermanager.cpp | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/opengl/glshadermanager.cpp b/src/opengl/glshadermanager.cpp
index 1263c64943..5123c1e183 100644
--- a/src/opengl/glshadermanager.cpp
+++ b/src/opengl/glshadermanager.cpp
@@ -160,9 +160,9 @@ QByteArray ShaderManager::generateFragmentSource(ShaderTraits traits) const
     if (traits & ShaderTrait::MapTexture) {
         // limited range BT601 in -> full range BT709 out
         stream << "vec4 transformY_UV(sampler2D tex0, sampler2D tex1, vec2 texcoord0) {\n";
-        stream << "    float y = 1.16438356 * (texture2D(tex0, texcoord0).x - 0.0625);\n";
-        stream << "    float u = texture2D(tex1, texcoord0).r - 0.5;\n";
-        stream << "    float v = texture2D(tex1, texcoord0).g - 0.5;\n";
+        stream << "    float y = 1.16438356 * (" << textureLookup << "(tex0, texcoord0).x - 0.0625);\n";
+        stream << "    float u = " << textureLookup << "(tex1, texcoord0).r - 0.5;\n";
+        stream << "    float v = " << textureLookup << "(tex1, texcoord0).g - 0.5;\n";
         stream << "    return vec4(y + 1.59602678 * v"
                   "              , y - 0.39176229 * u - 0.81296764 * v"
                   "              , y + 2.01723214 * u"
@@ -181,7 +181,7 @@ QByteArray ShaderManager::generateFragmentSource(ShaderTraits traits) const
         stream << "    }\n";
     } else if (traits & ShaderTrait::MapExternalTexture) {
         // external textures require texture2D for sampling
-        stream << "    result = texture2D(sampler, texcoord0);\n";
+        stream << "    result = " << textureLookup << "(sampler, texcoord0);\n";
     } else if (traits & ShaderTrait::UniformColor) {
         stream << "    result = geometryColor;\n";
     }
-- 
GitLab

